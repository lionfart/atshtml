<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Adalet Takip Sistemi - Dosya Detayı">
    <title>Dosya Detayı - Adalet Takip Sistemi</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- PDF.js for text extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- Styles -->
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal">
        <div class="modal-overlay" onclick="closeDeleteModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Dosyayı Sil</h2>
                <button class="icon-btn" onclick="closeDeleteModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <p class="modal-description">Bu dosyayı ve tüm içeriğini (evraklar, notlar) silmek istediğinize emin
                misiniz? Bu işlem geri alınamaz.</p>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">İptal</button>
                <button class="btn btn-danger" id="confirm-delete-btn" onclick="confirmDeleteFile()">
                    <i data-lucide="trash-2"></i>
                    <span>Sil</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Notes & History Modal -->
    <div id="notes-modal" class="modal">
        <div class="modal-overlay" onclick="closeNotesModal()"></div>
        <div class="modal-content"
            style="max-width:700px; max-height:80vh; overflow:hidden; display:flex; flex-direction:column;">
            <div class="modal-header">
                <h2><i data-lucide="notebook-text" style="width:20px;"></i> Notlar ve İşlem Geçmişi</h2>
                <button class="icon-btn" onclick="closeNotesModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div style="padding:20px; overflow-y:auto; flex:1;">
                <!-- Add Note Section -->
                <div style="margin-bottom:20px;">
                    <h3 style="font-size:0.95rem; margin-bottom:10px;">Yeni Not Ekle</h3>
                    <textarea id="modal-note-input" rows="3" class="form-control" placeholder="Not yazın..."></textarea>
                    <button class="btn btn-primary btn-sm" style="margin-top:10px;" onclick="addNoteFromModal()">
                        <i data-lucide="plus" style="width:14px;"></i> Not Ekle
                    </button>
                </div>
                <hr style="border-color:var(--border-color); margin:15px 0;">
                <!-- Notes List -->
                <h3 style="font-size:0.95rem; margin-bottom:10px;">Dosya Notları ve Sistem Kayıtları</h3>
                <div id="modal-notes-list" style="max-height:300px; overflow-y:auto;">
                    <div class="loading-placeholder">
                        <div class="spinner"></div>
                        <span>Yükleniyor...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <main class="container">
        <!-- Header -->
        <header class="header" id="page-header">
            <div class="header-left">
                <a href="files.html" class="btn btn-outline" style="margin-right: var(--space-4);">
                    <i data-lucide="arrow-left"></i>
                </a>
                <div>
                    <h1 id="file-number">Yükleniyor...</h1>
                    <p id="file-created-date" class="text-muted"></p>

                    <!-- AI Suggestion Box -->
                    <div id="ai-suggestion-box" style="
                        margin-top: 10px; 
                        padding: 10px; 
                        background: rgba(16, 185, 129, 0.1); 
                        border: 1px solid rgba(16, 185, 129, 0.3); 
                        border-radius: 8px; 
                        color: #fff; 
                        font-size: 0.9rem; 
                        display: flex; 
                        align-items: center; 
                        gap: 10px;">
                        <i data-lucide="sparkles" style="color: var(--accent-success); width: 16px;"></i>
                        <span id="ai-suggestion-text" style="font-style: italic;">AI Önerisi bekleniyor...</span>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="btn btn-danger" onclick="openDeleteModal()">
                    <i data-lucide="trash-2"></i>
                    <span>Dosyayı Sil</span>
                </button>
            </div>
        </header>

        <!-- Main Content Grid -->
        <div class="main-grid">
            <!-- Left Column - Details & Notes -->
            <div class="grid-column" style="grid-column: span 2;">
                <!-- Details Card (No Tabs) -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i data-lucide="file-text"></i>
                            Dosya Bilgileri
                        </h2>
                    </div>
                    <div class="card-content">
                        <form id="file-details-form">
                            <div class="grid-2-col"
                                style="display:grid; grid-template-columns: 1fr 1fr; gap:var(--space-4);">
                                <div class="form-group">
                                    <label for="edit-plaintiff">Davacı</label>
                                    <input type="text" id="edit-plaintiff" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-defendant">Davalı</label>
                                    <input type="text" id="edit-defendant">
                                </div>
                            </div>

                            <div class="grid-2-col"
                                style="display:grid; grid-template-columns: 1fr 1fr; gap:var(--space-4);">
                                <div class="form-group">
                                    <label for="edit-plaintiff-attorney">Davacı Vekili</label>
                                    <input type="text" id="edit-plaintiff-attorney" placeholder="Av. ...">
                                </div>
                                <div class="form-group">
                                    <label for="edit-defendant-attorney">Davalı Vekili</label>
                                    <input type="text" id="edit-defendant-attorney" placeholder="Av. ...">
                                </div>
                            </div>

                            <div class="grid-2-col"
                                style="display:grid; grid-template-columns: 1fr 1fr; gap:var(--space-4);">
                                <div class="form-group">
                                    <label for="edit-court">Mahkeme</label>
                                    <input type="text" id="edit-court">
                                </div>
                                <div class="form-group">
                                    <label for="edit-amount">Dava Değeri</label>
                                    <input type="text" id="edit-amount">
                                </div>
                            </div>

                            <div class="grid-2-col"
                                style="display:grid; grid-template-columns: 1fr 1fr; gap:var(--space-4);">
                                <div class="form-group">
                                    <label for="edit-reg-number">Esas No</label>
                                    <input type="text" id="edit-reg-number">
                                </div>
                                <div class="form-group">
                                    <label for="edit-decision-number">Karar No</label>
                                    <input type="text" id="edit-decision-number" placeholder="Örn: 2024/55 K.">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="edit-subject">Dava Konusu</label>
                                <textarea id="edit-subject" rows="4" style="resize: vertical;"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="edit-deadline" style="color:var(--accent-danger);">Kesin Süre
                                    (Deadline)</label>
                                <input type="date" id="edit-deadline" class="form-control"
                                    style="border-color:var(--accent-danger);">
                            </div>

                            <div class="form-group"
                                style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; border-left: 3px solid var(--accent-warning);">
                                <label style="color: var(--accent-warning);">Karar Sonucu</label>
                                <span id="display-decision-result" class="badge"
                                    style="font-size: 1rem; cursor:pointer; display:inline-flex; align-items:center; gap:5px; margin-top:5px; border:1px dashed rgba(255,255,255,0.3);"
                                    onclick="editDecisionResultInDetails()" title="Düzenlemek için tıklayın">
                                    <span id="decision-result-text">-</span>
                                    <i data-lucide="edit-2" style="width:12px; height:12px; opacity:0.7;"></i>
                                </span>
                            </div>
                            <button type="submit" class="btn btn-primary" id="save-details-btn">
                                <i data-lucide="save"></i>
                                <span>Değişiklikleri Kaydet</span>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Notes & History Collapsible Card -->
                <div class="card" style="margin-top:20px;">
                    <div class="card-header" style="cursor:pointer;" onclick="toggleNotesPanel()">
                        <h2 class="card-title" style="display:flex; align-items:center; gap:8px;">
                            <i data-lucide="notebook-text"></i>
                            Süreç & Notlar
                            <i id="notes-panel-icon" data-lucide="chevron-down"
                                style="margin-left:auto; width:18px;"></i>
                        </h2>
                    </div>
                    <div id="notes-panel-content" style="display:none;">
                        <div class="card-content">
                            <p class="text-muted" style="margin-bottom:15px; font-size:0.9rem;">Bu dosyaya dair alınan
                                notlar ve sistem kayıtları.</p>
                            <!-- Add Note Form -->
                            <div style="display:flex; gap:8px; margin-bottom:15px;">
                                <input type="text" id="new-note-input" class="form-control"
                                    placeholder="Yeni not ekle..." style="flex:1;">
                                <button class="btn btn-primary" onclick="addNote()">
                                    <i data-lucide="send" style="width:16px;"></i>
                                </button>
                            </div>
                            <!-- Notes List -->
                            <div class="notes-list" id="notes-list">
                                <div class="loading-placeholder">
                                    <div class="spinner"></div>
                                    <span>Notlar yükleniyor...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Status & Documents -->
            <div class="grid-column">
                <!-- Status + Tags Row (Side by Side) -->
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <!-- Status Card -->
                    <div class="card">
                        <div class="card-header" style="padding:10px 15px;">
                            <h2 class="card-title" style="font-size:0.9rem;">
                                <i data-lucide="info" style="width:14px;"></i>
                                Durum
                            </h2>
                        </div>
                        <div class="card-content" style="padding:10px 15px;">
                            <div id="status-content">
                                <div class="loading-placeholder">
                                    <div class="spinner"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tags Card -->
                    <div class="card">
                        <div class="card-header" style="padding:10px 15px;">
                            <h2 class="card-title" style="font-size:0.9rem;">
                                <i data-lucide="tag" style="width:14px;"></i>
                                Etiketler
                            </h2>
                        </div>
                        <div class="card-content" style="padding:10px 15px;">
                            <div id="tags-container"
                                style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;">
                                <span class="text-muted" style="font-size: 0.85em;">Etiket yok.</span>
                            </div>
                            <select id="primary-tag-select" class="form-control" style="width:100%; font-size:0.85rem;">
                                <option value="">Birincil Etiket</option>
                                <option value="Çevre">Çevre</option>
                                <option value="Şehircilik">Şehircilik</option>
                                <option value="Mevzuat">Mevzuat</option>
                                <option value="Diğer">Diğer</option>
                            </select>
                            <div style="display:flex; gap:6px; margin-top:8px;">
                                <input list="tag-suggestions" id="new-tag-input" class="form-control"
                                    placeholder="İkincil etiket..." style="flex:1; font-size:0.85rem;">
                                <datalist id="tag-suggestions">
                                    <option value="Adli">
                                    <option value="Deprem">
                                    <option value="Tazminat">
                                    <option value="Hasar">
                                </datalist>
                                <button type="button" class="btn btn-primary btn-sm" onclick="handleAddTag()">
                                    <i data-lucide="plus" style="width:14px;"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documents Card -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i data-lucide="file-text"></i>
                            Evraklar
                        </h2>
                        <span id="documents-count" class="text-muted" style="font-size: var(--font-size-sm);">(0)</span>
                    </div>
                    <div class="card-content">
                        <!-- Upload Area -->
                        <div class="form-group">
                            <label>Yeni Evrak Ekle</label>
                            <div class="file-upload-area" id="doc-upload-area" style="padding: var(--space-4);">
                                <input type="file" id="doc-upload-input" hidden>
                                <div class="file-upload-content">
                                    <i data-lucide="upload"></i>
                                    <span style="font-size: var(--font-size-sm);">Dosya yükle</span>
                                </div>
                            </div>
                            <!-- AI Checkbox -->
                            <div
                                style="margin-top:8px; display:flex; align-items:center; justify-content:center; gap:8px;">
                                <input type="checkbox" id="analyze-doc-checkbox" style="cursor:pointer;" checked>
                                <label for="analyze-doc-checkbox"
                                    style="font-size:0.85em; cursor:pointer; display:flex; align-items:center; gap:4px;">
                                    <i data-lucide="sparkles" style="width:14px; color:var(--accent-primary);"></i>
                                    Yapay Zeka ile İncele
                                </label>
                            </div>

                            <div id="doc-upload-progress" class="processing-indicator hidden">
                                <div class="spinner"></div>
                                <span>Yükleniyor...</span>
                            </div>
                        </div>

                        <!-- Documents List -->
                        <div class="documents-list" id="documents-list">
                            <!-- Documents will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p>Adalet Takip Sistemi © 2024</p>
    </footer>

    <!-- Drafting Modal -->
    <div id="drafting-modal" class="modal">
        <div class="modal-overlay" onclick="closeDraftingModal()"></div>
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i data-lucide="pen-tool"></i> Dilekçe Taslağı Oluştur</h3>
                <button class="icon-btn" onclick="closeDraftingModal()"><i data-lucide="x"></i></button>
            </div>
            <div style="padding: 20px;">
                <p class="text-muted" style="margin-bottom: 15px;">
                    Yapay zeka, seçili evrakın analizine dayanarak bir taslak oluşturacaktır.
                </p>
                <div class="form-group">
                    <label>Dilekçe Türü</label>
                    <select id="draft-type" class="form-control">
                        <option value="CEVAP">Cevap Dilekçesi</option>
                        <option value="ITIRAZ">İtiraz Dilekçesi</option>
                        <option value="BEYAN">Beyan Dilekçesi</option>
                        <option value="SAVUNMA">Savunma Dilekçesi</option>
                        <option value="ISTINAF">İstinaf Dilekçesi</option>
                        <option value="TEMYIZ">Temyiz Dilekçesi</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ek Talimatlar (Opsiyonel)</label>
                    <textarea id="draft-instructions" class="form-control" rows="3"
                        placeholder="Örn: Zamanaşımı itirazını vurgula..."></textarea>
                </div>
                <button class="btn btn-primary w-full" onclick="startDrafting()">
                    <i data-lucide="sparkles"></i> Taslağı Oluştur ve İndir (.docx)
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/toast.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.min.js"></script>

    <!-- DOCX & FileSaver -->
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script src="js/utils.js"></script>
    <script src="js/ui-modals.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/file-detail.js"></script>
    <script src="js/drafting.js"></script>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
    </script>
    <!-- AI Agent -->
    <script src="js/agent.js"></script>
</body>

</html>